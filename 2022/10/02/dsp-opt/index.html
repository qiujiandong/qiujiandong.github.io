<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>C6000 DSP优化技术入门 | 小裘控制系统</title><meta name="keywords" content="DSP,优化"><meta name="author" content="裘剑东"><meta name="copyright" content="裘剑东"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="参考资料  SPRU198K-TMS320C6000 Programmer’s Guide SPRUGH7-TMS320C66x DSP CPU and Instruction Set Reference Guide    主要是看了SPRU198K这个文档里的第三章，这一章里有5个Lesson，非常详细地介绍了一些很实用地优化方法。   在看这个之前最好对DSP数据路径和功能单元有了解，可以看S">
<meta property="og:type" content="article">
<meta property="og:title" content="C6000 DSP优化技术入门">
<meta property="og:url" content="http://qjdxmy.com/2022/10/02/dsp-opt/">
<meta property="og:site_name" content="小裘控制系统">
<meta property="og:description" content="参考资料  SPRU198K-TMS320C6000 Programmer’s Guide SPRUGH7-TMS320C66x DSP CPU and Instruction Set Reference Guide    主要是看了SPRU198K这个文档里的第三章，这一章里有5个Lesson，非常详细地介绍了一些很实用地优化方法。   在看这个之前最好对DSP数据路径和功能单元有了解，可以看S">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://qjdxmy.com/2022/10/02/dsp-opt/2022-10-02-22-20-37.png">
<meta property="article:published_time" content="2022-10-02T13:24:01.000Z">
<meta property="article:modified_time" content="2024-04-17T12:40:48.609Z">
<meta property="article:author" content="裘剑东">
<meta property="article:tag" content="DSP">
<meta property="article:tag" content="优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://qjdxmy.com/2022/10/02/dsp-opt/2022-10-02-22-20-37.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://qjdxmy.com/2022/10/02/dsp-opt/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'C6000 DSP优化技术入门',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-17 20:40:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/me.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">84</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">101</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/download/"><i class="fa-fw fas fa-download"></i><span> 下载</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/resume/"><i class="fa-fw fas fa-heart"></i><span> 个人简历</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小裘控制系统</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/download/"><i class="fa-fw fas fa-download"></i><span> 下载</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/resume/"><i class="fa-fw fas fa-heart"></i><span> 个人简历</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">C6000 DSP优化技术入门</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-02T13:24:01.000Z" title="发表于 2022-10-02 21:24:01">2022-10-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-17T12:40:48.609Z" title="更新于 2024-04-17 20:40:48">2024-04-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DSP%E5%BC%80%E5%8F%91/">DSP开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="C6000 DSP优化技术入门"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="参考资料-4">参考资料</h2>
<ul>
<li>SPRU198K-TMS320C6000 Programmer’s Guide</li>
<li>SPRUGH7-TMS320C66x DSP CPU and Instruction Set Reference Guide</li>
</ul>
<p>  主要是看了SPRU198K这个文档里的第三章，这一章里有5个Lesson，非常详细地介绍了一些很实用地优化方法。<br>
  在看这个之前最好对DSP数据路径和功能单元有了解，可以看SPRUGH7这个文档。只有充分发挥出8个功能单元的性能才能说是开发DSP，不然就只是单纯的C/C++开发。哦！还有我觉得起始看第三章之前可以先看一下第四章，第四章介绍了编译器反馈给用户的汇编文件中的一些短语的含义。</p>
<h2 id="一些准备-3">一些准备</h2>
<p>  DSP优化的过程并不是自己去写汇编而是尽可能多地告诉编译器一些信息，让编译器帮我们优化。<br>
  在工程选项中勾选上-mw和-k，那样可以在编译后生成汇编文件并且有软件流水线相关的信息，便于后续分析。</p>
<img src="/2022/10/02/dsp-opt/2022-10-02-22-20-37.png" class="">
<img src="/2022/10/02/dsp-opt/2022-10-02-22-19-26.png" class="">
<h2 id="Lesson1-循环内部依赖">Lesson1 - 循环内部依赖</h2>
<p>  以两个向量的线性乘加运算为例：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mrow><msub><mi>ω</mi><mn>1</mn></msub><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><msub><mi>ω</mi><mn>2</mn></msub><msub><mi>y</mi><mi>i</mi></msub></mrow></mrow><annotation encoding="application/x-tex">sum = \sum\limits_i { {\omega _1}{x_i} + {\omega _2}{y_i} } 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>  源操作数都是short类型，向量长度为N，可以用C语言写出下面这个函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">lesson</span><span class="params">(<span class="type">short</span> * xptr, <span class="type">short</span> * yptr, <span class="type">short</span> *zptr, <span class="type">short</span> *w_sum, <span class="type">int</span> N)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, w_vec1, w_vec2;</span><br><span class="line">    <span class="type">short</span> w1,w2;</span><br><span class="line"></span><br><span class="line">    w1 = zptr[<span class="number">0</span>];</span><br><span class="line">    w2 = zptr[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        w_vec1 = xptr[i] * w1;</span><br><span class="line">        w_vec2 = yptr[i] * w2;</span><br><span class="line">        w_sum[i] = (w_vec1 + w_vec2) &gt;&gt; <span class="number">15</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  采用Release模式，开启O2优化，编译得到的汇编文件中有如下注释，里面包含了很多信息。Lesson1主要关注的是Loop Carried Dependency Bound这个条目。“Carry”有进位的含义，我对Loop Carried Dependency Bound的理解大概是：循环中的每一轮对前一轮的依赖，前一轮运行了多少个周期后能够开始新一轮的计算。<br>
  采用软件流水线的方式实现时，循环结构不再是顺序执行，循环中的每一轮计算一起构成流水线的结构。我们不需要等前一轮的计算完全结束就可以开始下一轮的计算，只要两者之间没有前后依赖关系。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*   SOFTWARE PIPELINE INFORMATION</span><br><span class="line">;*</span><br><span class="line">;*      Loop found in file               : ../main.c</span><br><span class="line">;*      Loop source line                 : 24</span><br><span class="line">;*      Loop opening brace source line   : 25</span><br><span class="line">;*      Loop closing brace source line   : 29</span><br><span class="line">;*      Known Minimum Trip Count         : 1                    </span><br><span class="line">;*      Known Max Trip Count Factor      : 1</span><br><span class="line">;*      Loop Carried Dependency Bound(^) : 12</span><br><span class="line">;*      Unpartitioned Resource Bound     : 2</span><br><span class="line">;*      Partitioned Resource Bound(*)    : 2</span><br><span class="line">;*      Resource Partition:</span><br><span class="line">;*                                A-side   B-side</span><br><span class="line">;*      .L units                     0        0     </span><br><span class="line">;*      .S units                     1        0     </span><br><span class="line">;*      .D units                     2*       1     </span><br><span class="line">;*      .M units                     1        0     </span><br><span class="line">;*      .X cross paths               1        0     </span><br><span class="line">;*      .T address paths             2*       1     </span><br><span class="line">;*      Long read paths              0        0     </span><br><span class="line">;*      Long write paths             0        0     </span><br><span class="line">;*      Logical  ops (.LS)           1        0     (.L or .S unit)</span><br><span class="line">;*      Addition ops (.LSD)          0        0     (.L or .S or .D unit)</span><br><span class="line">;*      Bound(.L .S .LS)             1        0     </span><br><span class="line">;*      Bound(.L .S .D .LS .LSD)     2*       1     </span><br><span class="line">;*</span><br><span class="line">;*      Searching for software pipeline schedule at ...</span><br><span class="line">;*         ii = 12 Schedule found with 2 iterations in parallel</span><br><span class="line">;*</span><br><span class="line">;*      Register Usage Table:</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*          |AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB|</span><br><span class="line">;*          |00000000001111111111222222222233|00000000001111111111222222222233|</span><br><span class="line">;*          |01234567890123456789012345678901|01234567890123456789012345678901|</span><br><span class="line">;*          |--------------------------------+--------------------------------|</span><br><span class="line">;*       0: |    *                           |     ***                        |</span><br><span class="line">;*       1: |    *                           |     ***                        |</span><br><span class="line">;*       2: |    *                           |     ***                        |</span><br><span class="line">;*       3: |    *                           |     ***                        |</span><br><span class="line">;*       4: |    *                           |     ***                        |</span><br><span class="line">;*       5: |   **                           |    ****                        |</span><br><span class="line">;*       6: |    *                           |    ****                        |</span><br><span class="line">;*       7: |    *                           |     ***                        |</span><br><span class="line">;*       8: |    *                           |     ***                        |</span><br><span class="line">;*       9: |    *                           |     ***                        |</span><br><span class="line">;*      10: |    *                           |    ****                        |</span><br><span class="line">;*      11: |    *                           |    ****                        |</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*</span><br><span class="line">;*      Done</span><br><span class="line">;*</span><br><span class="line">;*      Loop will be splooped</span><br><span class="line">;*      Collapsed epilog stages       : 0</span><br><span class="line">;*      Collapsed prolog stages       : 0</span><br><span class="line">;*      Minimum required memory pad   : 0 bytes</span><br><span class="line">;*</span><br><span class="line">;*      Minimum safe trip count       : 1</span><br><span class="line">;*      Min. prof. trip count  (est.) : 13</span><br><span class="line">;*</span><br><span class="line">;*      Mem bank conflicts/iter(est.) : &#123; min 0.000, est 0.125, max 1.000 &#125;</span><br><span class="line">;*      Mem bank perf. penalty (est.) : 1.0%</span><br><span class="line">;*</span><br><span class="line">;*      Effective ii                : &#123; min 12.00, est 12.13, max 13.00 &#125;</span><br><span class="line">;*</span><br><span class="line">;*</span><br><span class="line">;*      Total cycles (est.)         : 12 + trip_cnt * 12        </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*        SINGLE SCHEDULED ITERATION</span><br><span class="line">;*</span><br><span class="line">;*        $C$C25:</span><br><span class="line">;*   0              LDH     .D2T2   *B7++,B4          ; |28|  ^ </span><br><span class="line">;*     ||           LDH     .D1T1   *A4++,A3          ; |28|  ^ </span><br><span class="line">;*   1              NOP             4</span><br><span class="line">;*   5              PACK2   .L2X    B4,A3,B4          ; |28|  ^ </span><br><span class="line">;*   6              DOTP2   .M2     B4,B5,B4          ; |28|  ^ </span><br><span class="line">;*   7              NOP             3</span><br><span class="line">;*  10              SHR     .S2     B4,15,B4          ; |28|  ^ </span><br><span class="line">;*  11              STH     .D2T2   B4,*B6++          ; |28|  ^ </span><br><span class="line">;*     ||           SPBR            $C$C25</span><br><span class="line">;*  12              NOP             9</span><br><span class="line">;*  24              ; BRANCHCC OCCURS &#123;$C$C25&#125;        ; |24| </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br></pre></td></tr></table></figure>
<p>  ii是iteration interval的简称，表示循环中每一轮计算的时间。可以看到Loop Carried Dependency Bound是12，而且ii也是12。这表明软件流水线根本没起作用，每一轮计算都得等上一轮计算结束才能开始。<br>
  Loop Carried Dependency Bound后面有一个“^”的符号，在最后的汇编代码中也可以看到，这是编译器帮我们标注出来的“关键路径”，表明执行这些汇编指令的时候形成了前后依赖关系。<br>
  我们其实自己知道向量中的每一个元素的计算都是相互独立地，并不存在前后地依赖关系。但编译器不知道这点，它看到有两个指针在先后读写存储器，就会采取一种保守地策略，认为需要写指针完成写操作后才能通过读指针读存储器。<br>
  有两种方式可以告诉编译器这一额外的信息。<strong>一、用restrict限定指针；二、编译时加上“-mt”的编译选项。</strong><br>
  在指针变量声明的时候加上restrict限定可以告诉编译器这个指针访问的数据只有它能够访问，其它指针的数据读写和它无关。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">lesson</span><span class="params">(<span class="type">short</span> * <span class="keyword">restrict</span> xptr, <span class="type">short</span> * <span class="keyword">restrict</span> yptr, <span class="type">short</span> *zptr, <span class="type">short</span> *w_sum, <span class="type">int</span> N)</span></span><br></pre></td></tr></table></figure>
<p>  “-mt”的选项能够假设没有那种两个指针访问同一片存储区的情况。</p>
<img src="/2022/10/02/dsp-opt/2022-10-03-11-07-47.png" class="">
<p>  DSP进行计算的过程中，Load和Store是非常费时间的，Load完成需要5个周期，Store完成需要4个周期。在很多情况下，往往就是Load和Store形成了计算速度的瓶颈，所以在用指针的时候需要特别注意这种情况。</p>
<p>给指针添加“restrict”限定后的软件流水线信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*   SOFTWARE PIPELINE INFORMATION</span><br><span class="line">;*</span><br><span class="line">;*      Loop found in file               : ../main.c</span><br><span class="line">;*      Loop source line                 : 24</span><br><span class="line">;*      Loop opening brace source line   : 25</span><br><span class="line">;*      Loop closing brace source line   : 29</span><br><span class="line">;*      Known Minimum Trip Count         : 1                    </span><br><span class="line">;*      Known Max Trip Count Factor      : 1</span><br><span class="line">;*      Loop Carried Dependency Bound(^) : 0</span><br><span class="line">;*      Unpartitioned Resource Bound     : 2</span><br><span class="line">;*      Partitioned Resource Bound(*)    : 2</span><br><span class="line">;*      Resource Partition:</span><br><span class="line">;*                                A-side   B-side</span><br><span class="line">;*      .L units                     0        0     </span><br><span class="line">;*      .S units                     0        1     </span><br><span class="line">;*      .D units                     1        2*    </span><br><span class="line">;*      .M units                     0        1     </span><br><span class="line">;*      .X cross paths               0        1     </span><br><span class="line">;*      .T address paths             1        2*    </span><br><span class="line">;*      Long read paths              0        0     </span><br><span class="line">;*      Long write paths             0        0     </span><br><span class="line">;*      Logical  ops (.LS)           0        1     (.L or .S unit)</span><br><span class="line">;*      Addition ops (.LSD)          0        0     (.L or .S or .D unit)</span><br><span class="line">;*      Bound(.L .S .LS)             0        1     </span><br><span class="line">;*      Bound(.L .S .D .LS .LSD)     1        2*    </span><br><span class="line">;*</span><br><span class="line">;*      Searching for software pipeline schedule at ...</span><br><span class="line">;*         ii = 2  Schedule found with 6 iterations in parallel</span><br><span class="line">;*</span><br><span class="line">;*      Register Usage Table:</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*          |AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB|</span><br><span class="line">;*          |00000000001111111111222222222233|00000000001111111111222222222233|</span><br><span class="line">;*          |01234567890123456789012345678901|01234567890123456789012345678901|</span><br><span class="line">;*          |--------------------------------+--------------------------------|</span><br><span class="line">;*       0: |    *                           |    *****                       |</span><br><span class="line">;*       1: |   **                           |    *****                       |</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*</span><br><span class="line">;*      Done</span><br><span class="line">;*</span><br><span class="line">;*      Loop will be splooped</span><br><span class="line">;*      Collapsed epilog stages       : 0</span><br><span class="line">;*      Collapsed prolog stages       : 0</span><br><span class="line">;*      Minimum required memory pad   : 0 bytes</span><br><span class="line">;*</span><br><span class="line">;*      Minimum safe trip count       : 1</span><br><span class="line">;*      Min. prof. trip count  (est.) : 2</span><br><span class="line">;*</span><br><span class="line">;*      Mem bank conflicts/iter(est.) : &#123; min 0.000, est 0.125, max 1.000 &#125;</span><br><span class="line">;*      Mem bank perf. penalty (est.) : 5.9%</span><br><span class="line">;*</span><br><span class="line">;*      Effective ii                : &#123; min 2.00, est 2.13, max 3.00 &#125;</span><br><span class="line">;*</span><br><span class="line">;*</span><br><span class="line">;*      Total cycles (est.)         : 10 + trip_cnt * 2        </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*        SINGLE SCHEDULED ITERATION</span><br><span class="line">;*</span><br><span class="line">;*        $C$C22:</span><br><span class="line">;*   0              LDH     .D2T2   *B6++,B8          ; |28| </span><br><span class="line">;*     ||           LDH     .D1T1   *A4++,A3          ; |28| </span><br><span class="line">;*   1              NOP             4</span><br><span class="line">;*   5              PACK2   .L2X    B8,A3,B8          ; |28| </span><br><span class="line">;*   6              DOTP2   .M2     B8,B5,B4          ; |28| </span><br><span class="line">;*   7              NOP             3</span><br><span class="line">;*  10              SHR     .S2     B4,15,B4          ; |28| </span><br><span class="line">;*  11              STH     .D2T2   B4,*B7++          ; |28| </span><br><span class="line">;*     ||           SPBR            $C$C22</span><br><span class="line">;*  12              ; BRANCHCC OCCURS &#123;$C$C22&#125;        ; |24| </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br></pre></td></tr></table></figure>
<p>  可以看到添加了“restrict”限定之后，Loop Carried Dependency Bound变为0，前后两轮计算之间不再有依赖关系，ii从12降低到了2，运算效率大幅度提高！</p>
<h2 id="Lesson2-平衡两条数据路径">Lesson2 - 平衡两条数据路径</h2>
<p>  观察前面优化后的Resource Partition，可以看到AB两条数据路径的使用并不对称。B中的功能单元用得更多，而A中的功能单元大部分是空闲的。<br>
  这里可以用到循环展开（Loop Unroll）的技术。一般情况下循环N次，那么这个循环的trip count就是N。而有时候可以把相邻的两轮计算当作一次trip，那么这个循环的trip count就是N/2。DSP软件在用软件流水线优化以后，循环的次数就是用trip count来衡量的。<br>
  编译器不会自动地展开循环，只有在知道某个循环必定会执行N次或者执行的次数必定为某个数的整数倍时才会尝试展开循环。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> MUST_ITRATE(min, max, multiple);</span></span><br></pre></td></tr></table></figure>
<p>  用MUST_ITERATE可以说明一个循环的最小循环次数min、最大循环次数max和循环次数的整数因子。比如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> MUST_ITERATE(2, , 2);</span></span><br></pre></td></tr></table></figure>
<p>可以告诉编译器下面的for循环最小执行2次，而且执行次数是2的整数倍。把这行代码应用到前面的例子里就像下面这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> MUST_ITERATE(2, , 2);</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        w_vec1 = xptr[i] * w1;</span><br><span class="line">        w_vec2 = yptr[i] * w2;</span><br><span class="line">        w_sum[i] = (w_vec1 + w_vec2) &gt;&gt; <span class="number">15</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>重新编译得到如下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*   SOFTWARE PIPELINE INFORMATION</span><br><span class="line">;*</span><br><span class="line">;*      Loop found in file               : ../main.c</span><br><span class="line">;*      Loop source line                 : 25</span><br><span class="line">;*      Loop opening brace source line   : 26</span><br><span class="line">;*      Loop closing brace source line   : 30</span><br><span class="line">;*      Loop Unroll Multiple             : 2x</span><br><span class="line">;*      Known Minimum Trip Count         : 1                    </span><br><span class="line">;*      Known Max Trip Count Factor      : 1</span><br><span class="line">;*      Loop Carried Dependency Bound(^) : 0</span><br><span class="line">;*      Unpartitioned Resource Bound     : 2</span><br><span class="line">;*      Partitioned Resource Bound(*)    : 3</span><br><span class="line">;*      Resource Partition:</span><br><span class="line">;*                                A-side   B-side</span><br><span class="line">;*      .L units                     0        0     </span><br><span class="line">;*      .S units                     1        1     </span><br><span class="line">;*      .D units                     2        2     </span><br><span class="line">;*      .M units                     0        2     </span><br><span class="line">;*      .X cross paths               1        1     </span><br><span class="line">;*      .T address paths             3*       3*    </span><br><span class="line">;*      Long read paths              0        0     </span><br><span class="line">;*      Long write paths             0        0     </span><br><span class="line">;*      Logical  ops (.LS)           1        2     (.L or .S unit)</span><br><span class="line">;*      Addition ops (.LSD)          0        0     (.L or .S or .D unit)</span><br><span class="line">;*      Bound(.L .S .LS)             1        2     </span><br><span class="line">;*      Bound(.L .S .D .LS .LSD)     2        2     </span><br><span class="line">;*</span><br><span class="line">;*      Searching for software pipeline schedule at ...</span><br><span class="line">;*         ii = 3  Schedule found with 5 iterations in parallel</span><br><span class="line">;*</span><br><span class="line">;*      Register Usage Table:</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*          |AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB|</span><br><span class="line">;*          |00000000001111111111222222222233|00000000001111111111222222222233|</span><br><span class="line">;*          |01234567890123456789012345678901|01234567890123456789012345678901|</span><br><span class="line">;*          |--------------------------------+--------------------------------|</span><br><span class="line">;*       0: |   ****                         |    ** ***      *               |</span><br><span class="line">;*       1: |   ****                         |    ******      *               |</span><br><span class="line">;*       2: |   ****                         |    **** *      *               |</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*</span><br><span class="line">;*      Done</span><br><span class="line">;*</span><br><span class="line">;*      Loop will be splooped</span><br><span class="line">;*      Collapsed epilog stages       : 0</span><br><span class="line">;*      Collapsed prolog stages       : 0</span><br><span class="line">;*      Minimum required memory pad   : 0 bytes</span><br><span class="line">;*</span><br><span class="line">;*      Minimum safe trip count       : 1 (after unrolling)</span><br><span class="line">;*      Min. prof. trip count  (est.) : 2 (after unrolling)</span><br><span class="line">;*</span><br><span class="line">;*      Mem bank conflicts/iter(est.) : &#123; min 1.000, est 1.000, max 1.000 &#125;</span><br><span class="line">;*      Mem bank perf. penalty (est.) : 25.0%</span><br><span class="line">;*</span><br><span class="line">;*      Effective ii                : 4.0</span><br><span class="line">;*</span><br><span class="line">;*</span><br><span class="line">;*      Total cycles (est.)         : 12 + trip_cnt * 3        </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*       SETUP CODE</span><br><span class="line">;*</span><br><span class="line">;*                  MV              A6,B9</span><br><span class="line">;*                  ADD             6,B9,B9</span><br><span class="line">;*                  ADD             4,A6,A6</span><br><span class="line">;*</span><br><span class="line">;*        SINGLE SCHEDULED ITERATION</span><br><span class="line">;*</span><br><span class="line">;*        $C$C23:</span><br><span class="line">;*   0              LDNW    .D1T1   *A3++(4),A5       ; |29| </span><br><span class="line">;*   1              LDNW    .D2T2   *B7++(4),B4       ; |29| </span><br><span class="line">;*   2              NOP             3</span><br><span class="line">;*   5              UNPKH2  .L1     A5,A5:A4          ; |29| </span><br><span class="line">;*   6              UNPKH2  .L2     B4,B5:B4          ; |29| </span><br><span class="line">;*   7              DPACKL2 .L2X    B5:B4,A5:A4,B5:B4 ; |29| </span><br><span class="line">;*   8              DOTP2   .M2     B4,B16,B8         ; |29| </span><br><span class="line">;*   9              DOTP2   .M2     B5,B16,B6         ; |29| </span><br><span class="line">;*  10              NOP             3</span><br><span class="line">;*  13              SHR     .S1X    B8,15,A4          ; |29| </span><br><span class="line">;*     ||           SHR     .S2     B6,15,B6          ; |29| </span><br><span class="line">;*  14              STH     .D1T1   A4,*A6++(4)       ; |29| </span><br><span class="line">;*     ||           STH     .D2T2   B6,*B9++(4)       ; |29| </span><br><span class="line">;*     ||           SPBR            $C$C23</span><br><span class="line">;*  15              ; BRANCHCC OCCURS &#123;$C$C23&#125;        ; |25| </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br></pre></td></tr></table></figure>
<p>  ii从2变为了3，实际上是经过了循环展开，新的代码中trip count减小了一半。所以实际上可以理解为ii从2变为了1.5，计算效率进一步得到提升。</p>
<h2 id="Lesson3-地址对齐">Lesson3 - 地址对齐</h2>
<p>  再仔细观察上面的软件流水线信息，.T address path总共用了6次。因为两次取操作数和写回计算结果是3次，又经过了循环展开，所以总共是6次。<br>
  但实际上我们的操作数都是short类型的，如果把两个连续的操作数一起load，那么可以将.T adrress path的使用次数降低到4次。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">lesson</span><span class="params">(<span class="type">short</span> * <span class="keyword">restrict</span> xptr, <span class="type">short</span> * <span class="keyword">restrict</span> yptr, <span class="type">short</span> *zptr, <span class="type">short</span> *w_sum, <span class="type">int</span> N)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i, w_vec1, w_vec2;</span><br><span class="line">    <span class="type">short</span> w1,w2;</span><br><span class="line"></span><br><span class="line">    _nassert(((<span class="type">int</span>)xptr &amp; <span class="number">0x3</span>) == <span class="number">0</span>);</span><br><span class="line">    _nassert(((<span class="type">int</span>)yptr &amp; <span class="number">0x3</span>) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    w1 = zptr[<span class="number">0</span>];</span><br><span class="line">    w2 = zptr[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">pragma</span> MUST_ITERATE(2, , 2);</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        w_vec1 = xptr[i] * w1;</span><br><span class="line">        w_vec2 = yptr[i] * w2;</span><br><span class="line">        w_sum[i] = (w_vec1 + w_vec2) &gt;&gt; <span class="number">15</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  新增加的_nassert语句不会生成额外的代码，但可以告诉编译器更多的信息。_nassert()后的括号内的表达式为真。增加了新的约束后就告诉了编译器xptr和yptr是8字节对齐的，可以用LDW直接load两个short类型的数据，如果没有这个信息，编译器只会用LDNW指令来load非对齐的32bit数据，相对来说会慢一点。<br>
  编译后的软件流水线信息如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*   SOFTWARE PIPELINE INFORMATION</span><br><span class="line">;*</span><br><span class="line">;*      Loop found in file               : ../main.c</span><br><span class="line">;*      Loop source line                 : 29</span><br><span class="line">;*      Loop opening brace source line   : 30</span><br><span class="line">;*      Loop closing brace source line   : 34</span><br><span class="line">;*      Loop Unroll Multiple             : 2x</span><br><span class="line">;*      Known Minimum Trip Count         : 1                    </span><br><span class="line">;*      Known Max Trip Count Factor      : 1</span><br><span class="line">;*      Loop Carried Dependency Bound(^) : 0</span><br><span class="line">;*      Unpartitioned Resource Bound     : 2</span><br><span class="line">;*      Partitioned Resource Bound(*)    : 2</span><br><span class="line">;*      Resource Partition:</span><br><span class="line">;*                                A-side   B-side</span><br><span class="line">;*      .L units                     0        0     </span><br><span class="line">;*      .S units                     1        1     </span><br><span class="line">;*      .D units                     2*       2*    </span><br><span class="line">;*      .M units                     0        2*    </span><br><span class="line">;*      .X cross paths               1        1     </span><br><span class="line">;*      .T address paths             2*       2*    </span><br><span class="line">;*      Long read paths              0        0     </span><br><span class="line">;*      Long write paths             0        0     </span><br><span class="line">;*      Logical  ops (.LS)           1        2     (.L or .S unit)</span><br><span class="line">;*      Addition ops (.LSD)          0        0     (.L or .S or .D unit)</span><br><span class="line">;*      Bound(.L .S .LS)             1        2*    </span><br><span class="line">;*      Bound(.L .S .D .LS .LSD)     2*       2*    </span><br><span class="line">;*</span><br><span class="line">;*      Searching for software pipeline schedule at ...</span><br><span class="line">;*         ii = 2  Schedule found with 8 iterations in parallel</span><br><span class="line">;*</span><br><span class="line">;*      Register Usage Table:</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*          |AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB|</span><br><span class="line">;*          |00000000001111111111222222222233|00000000001111111111222222222233|</span><br><span class="line">;*          |01234567890123456789012345678901|01234567890123456789012345678901|</span><br><span class="line">;*          |--------------------------------+--------------------------------|</span><br><span class="line">;*       0: |   *****                        |    ******      **              |</span><br><span class="line">;*       1: |   ******                       |    ******      **              |</span><br><span class="line">;*          +-----------------------------------------------------------------+</span><br><span class="line">;*</span><br><span class="line">;*      Done</span><br><span class="line">;*</span><br><span class="line">;*      Loop will be splooped</span><br><span class="line">;*      Collapsed epilog stages       : 0</span><br><span class="line">;*      Collapsed prolog stages       : 0</span><br><span class="line">;*      Minimum required memory pad   : 0 bytes</span><br><span class="line">;*</span><br><span class="line">;*      Minimum safe trip count       : 1 (after unrolling)</span><br><span class="line">;*      Min. prof. trip count  (est.) : 2 (after unrolling)</span><br><span class="line">;*</span><br><span class="line">;*      Mem bank conflicts/iter(est.) : &#123; min 1.000, est 1.125, max 2.000 &#125;</span><br><span class="line">;*      Mem bank perf. penalty (est.) : 36.0%</span><br><span class="line">;*</span><br><span class="line">;*      Effective ii                : &#123; min 3.00, est 3.13, max 4.00 &#125;</span><br><span class="line">;*</span><br><span class="line">;*</span><br><span class="line">;*      Total cycles (est.)         : 14 + trip_cnt * 2        </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br><span class="line">;*       SETUP CODE</span><br><span class="line">;*</span><br><span class="line">;*                  MV              A7,B16</span><br><span class="line">;*                  ADD             6,B16,B16</span><br><span class="line">;*                  ADD             4,A7,A7</span><br><span class="line">;*</span><br><span class="line">;*        SINGLE SCHEDULED ITERATION</span><br><span class="line">;*</span><br><span class="line">;*        $C$C22:</span><br><span class="line">;*   0              LDW     .D1T1   *A6++,A3          ; |33| </span><br><span class="line">;*   1              NOP             1</span><br><span class="line">;*   2              LDW     .D2T2   *B8++,B5          ; |33| </span><br><span class="line">;*   3              NOP             3</span><br><span class="line">;*   6              UNPKH2  .L1     A3,A5:A4          ; |33| </span><br><span class="line">;*   7              UNPKH2  .L2     B5,B5:B4          ; |33| </span><br><span class="line">;*   8              DPACKL2 .L2X    B5:B4,A5:A4,B7:B6 ; |33| </span><br><span class="line">;*   9              DOTP2   .M2     B6,B17,B9         ; |33| </span><br><span class="line">;*  10              DOTP2   .M2     B7,B17,B6         ; |33| </span><br><span class="line">;*  11              NOP             3</span><br><span class="line">;*  14              SHR     .S1X    B9,15,A8          ; |33| </span><br><span class="line">;*     ||           SHR     .S2     B6,15,B4          ; |33| </span><br><span class="line">;*  15              STH     .D1T1   A8,*A7++(4)       ; |33| </span><br><span class="line">;*     ||           STH     .D2T2   B4,*B16++(4)      ; |33| </span><br><span class="line">;*     ||           SPBR            $C$C22</span><br><span class="line">;*  16              ; BRANCHCC OCCURS &#123;$C$C22&#125;        ; |29| </span><br><span class="line">;*----------------------------------------------------------------------------*</span><br></pre></td></tr></table></figure>
<p>  可以看到新的ii已经相当于是从1.5降低到了1，计算效率进一步提高。</p>
<h2 id="Lesson4-程序级优化">Lesson4 - 程序级优化</h2>
<p>  编译器编译过程中只能看到某个函数作用域内的信息，再工程选项中勾选程序级优化（-pm）有时候也能实现前面的优化效果。</p>
<img src="/2022/10/02/dsp-opt/2022-10-06-10-51-54.png" class="">
<h2 id="Lesson5-线性汇编">Lesson5 - 线性汇编</h2>
<p>  写线性汇编我觉得是最后没办法的办法了，用汇编指令顺序地将计算过程写下来，编译器再对这些汇编指令进行并行、流水线的处理。我也不知道这样能提升多少，感觉会是费力不讨好的事情。可能写了半天线性汇编，最后提升的也就只有一点点。挖个坑，等之后如果我遇到了这种需求，再写一下这部分内容把。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">裘剑东</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://qjdxmy.com/2022/10/02/dsp-opt/">http://qjdxmy.com/2022/10/02/dsp-opt/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://qjdxmy.com" target="_blank">小裘控制系统</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/DSP/">DSP</a><a class="post-meta__tags" href="/tags/%E4%BC%98%E5%8C%96/">优化</a></div><div class="post_share"><div class="social-share" data-image="/2022/10/02/dsp-opt/2022-10-02-22-20-37.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/10/02/fft-hw/"><img class="prev-cover" src="/2022/10/02/fft-hw/2022-10-02-17-54-54.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">硬件FFT加速模块的应用</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/07/bmprw/"><img class="next-cover" src="/2022/10/07/bmprw/2022-10-07-11-17-27.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">C/C++读写BMP文件</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/03/09/phase-review-1/" title="近期C6000 DSP开发小结"><img class="cover" src="/2022/03/09/phase-review-1/2022-03-09-22-40-16.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-09</div><div class="title">近期C6000 DSP开发小结</div></div></a></div><div><a href="/2022/05/26/c6678-openmp/" title="OpenMP在多核DSP上的应用"><img class="cover" src="/2022/05/26/c6678-openmp/2022-05-26-10-31-10.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-26</div><div class="title">OpenMP在多核DSP上的应用</div></div></a></div><div><a href="/2022/04/30/cpp-stm32/" title="C++开发STM32 FreeRTOS工程与添加DSP库"><img class="cover" src="/2022/04/30/cpp-stm32/2022-04-30-09-44-59.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-30</div><div class="title">C++开发STM32 FreeRTOS工程与添加DSP库</div></div></a></div><div><a href="/2022/02/27/c6455-1/" title="TMS320C6455入门实践（一）"><img class="cover" src="/2022/02/27/c6455-1/2022-02-27-16-54-12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-27</div><div class="title">TMS320C6455入门实践（一）</div></div></a></div><div><a href="/2022/02/27/c6455-10/" title="TMS320C6455入门实践（十）"><img class="cover" src="/2022/02/27/c6455-10/2022-02-27-19-49-41.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-27</div><div class="title">TMS320C6455入门实践（十）</div></div></a></div><div><a href="/2022/02/27/c6455-2/" title="TMS320C6455入门实践（二）"><img class="cover" src="/2022/02/27/c6455-2/2022-02-27-17-27-11.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-27</div><div class="title">TMS320C6455入门实践（二）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/me.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">裘剑东</div><div class="author-info__description">芯来科技基础软件开发工程师，嵌入式开发爱好者</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">84</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">101</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/qiujiandong"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/qiujiandong" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1335521934@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">最好的程序员做自己的硬件！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99-4"><span class="toc-number">1.</span> <span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%87%86%E5%A4%87-3"><span class="toc-number">2.</span> <span class="toc-text">一些准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lesson1-%E5%BE%AA%E7%8E%AF%E5%86%85%E9%83%A8%E4%BE%9D%E8%B5%96"><span class="toc-number">3.</span> <span class="toc-text">Lesson1 - 循环内部依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lesson2-%E5%B9%B3%E8%A1%A1%E4%B8%A4%E6%9D%A1%E6%95%B0%E6%8D%AE%E8%B7%AF%E5%BE%84"><span class="toc-number">4.</span> <span class="toc-text">Lesson2 - 平衡两条数据路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lesson3-%E5%9C%B0%E5%9D%80%E5%AF%B9%E9%BD%90"><span class="toc-number">5.</span> <span class="toc-text">Lesson3 - 地址对齐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lesson4-%E7%A8%8B%E5%BA%8F%E7%BA%A7%E4%BC%98%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">Lesson4 - 程序级优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lesson5-%E7%BA%BF%E6%80%A7%E6%B1%87%E7%BC%96"><span class="toc-number">7.</span> <span class="toc-text">Lesson5 - 线性汇编</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/01/01/summary-2024/" title="2024年终总结"><img src="/2025/01/01/summary-2024/2025-01-01-21-54-27.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024年终总结"/></a><div class="content"><a class="title" href="/2025/01/01/summary-2024/" title="2024年终总结">2024年终总结</a><time datetime="2025-01-01T09:19:27.000Z" title="发表于 2025-01-01 17:19:27">2025-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/17/learn-cuda/" title="CUDA优化入门"><img src="/2024/04/17/learn-cuda/2024-04-16-15-52-38.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CUDA优化入门"/></a><div class="content"><a class="title" href="/2024/04/17/learn-cuda/" title="CUDA优化入门">CUDA优化入门</a><time datetime="2024-04-17T12:00:00.000Z" title="发表于 2024-04-17 20:00:00">2024-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/04/bipartite-match/" title="二分图的判断与匹配"><img src="/2024/04/04/bipartite-match/2024-04-05-00-11-55.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="二分图的判断与匹配"/></a><div class="content"><a class="title" href="/2024/04/04/bipartite-match/" title="二分图的判断与匹配">二分图的判断与匹配</a><time datetime="2024-04-04T13:43:47.000Z" title="发表于 2024-04-04 21:43:47">2024-04-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/19/summary/" title="长风破浪会有时"><img src="/2024/01/19/summary/wrapped2023.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="长风破浪会有时"/></a><div class="content"><a class="title" href="/2024/01/19/summary/" title="长风破浪会有时">长风破浪会有时</a><time datetime="2024-01-19T13:15:25.000Z" title="发表于 2024-01-19 21:15:25">2024-01-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/05/remote-vivado/" title="Vivado远程开发探索"><img src="/2023/06/05/remote-vivado/2023-06-15-16-22-13.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vivado远程开发探索"/></a><div class="content"><a class="title" href="/2023/06/05/remote-vivado/" title="Vivado远程开发探索">Vivado远程开发探索</a><time datetime="2023-06-05T09:52:47.000Z" title="发表于 2023-06-05 17:52:47">2023-06-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 裘剑东</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>